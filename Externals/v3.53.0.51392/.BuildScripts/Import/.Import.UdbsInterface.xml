<!--
This file can be imported into any project to add a conditional project reference, 
with the build configuration based on the .NET Framework and platform.

Example usage (update path relative to file containing the Import node):
	<Import Project=".BuildScripts\NuGet\UdbsInterfaces.xml" Condition="'$(ImportedUdbsInterface)' != 'true'" />
  
Dependency tree (top-down): FractalSteps - Fractal - MesTestData.Library - MesTestData.UDBS - UdbsInterface

Nested Dependencies: ClosedXML , SQLite

Selection priority:
1. external source code, if '$(ReferenceSourceCode)' == 'true' and source code exists
2. GAC, if '$(ReferenceSharedUDBS)' == 'true'
3. external binary, if exists. 
   - If $(ReferenceSourceCode), search bottom up; 
   - If not $(ReferenceSourceCode) or not found, search top-down in Externals of project
4. internal NuGet server, hosted at http://osatnugetserver.li.lumentuminc.net/nuget

By using a shared file, all projects are guaranteed to reference the same version,
and if we want to upgrade, only one file needs to be updated.
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <!-- Set Imported = true, to use as a condition to prevent multiple nested imports -->
    <ImportedUdbsInterface>true</ImportedUdbsInterface>
    <!-- Custom property to find the path of the external references for the project -->
    <!-- Default to "unknown" for not found -->
    <PathUdbsInterface>unknown</PathUdbsInterface>
  </PropertyGroup>
  <Choose>
    <When Condition="'$(ReferenceSourceCode)' == 'true' And Exists('..\UdbsInterface\UdbsInterface.vbproj')">   
      <!-- Add project reference from source -->
      <ItemGroup>
        <ProjectReference Include="..\UdbsInterface\UdbsInterface.vbproj">
          <Project>{C18E3D46-B578-4C10-8294-8C46581C8878}</Project>
          <Name>UdbsInterface</Name>
        </ProjectReference>
      </ItemGroup>
      <!-- PathUdbsInterface N/A when using project reference from source -->
      <PropertyGroup>
        <PathUdbsInterface>na</PathUdbsInterface>
      </PropertyGroup>    
    </When>
    <When Condition="'$(ReferenceSharedUDBS)' == 'true'">
      <PropertyGroup>
        <PathUdbsInterface>gac</PathUdbsInterface>
      </PropertyGroup>
    </When>
  </Choose>  
  <Choose>  
    <When Condition="'$(PathUdbsInterface)' == 'unknown' And '$(ReferenceSourceCode)' == 'true'">    
      <!-- Search Source Code externals: Look from bottom to top -->
      <Choose>
        <!-- MesTestData.UDBS -->
        <When Condition="Exists('..\MesTestData.UDBS\Externals\UdbsInterface')">
          <PropertyGroup>
            <PathUdbsInterface>..\MesTestData.UDBS\Externals\UdbsInterface</PathUdbsInterface>
          </PropertyGroup>
        </When>
        <!-- MesTestData.Library -->
        <When Condition="Exists('..\MesTestData.Library\Externals\MesTestData.UDBS')">
          <PropertyGroup>
            <PathUdbsInterface>..\MesTestData.Library\Externals\MesTestData.UDBS</PathUdbsInterface>
          </PropertyGroup>
        </When>
        <!-- Fractal -->
        <When Condition="Exists('..\Fractal\Externals\MesTestData.Library')">
          <PropertyGroup>
            <PathUdbsInterface>..\Fractal\Externals\MesTestData.Library</PathUdbsInterface>
          </PropertyGroup>
        </When>
        <!-- FractalSteps -->
        <When Condition="Exists('..\FractalSteps\Externals\Fractal')">
          <PropertyGroup>
            <PathUdbsInterface>..\FractalSteps\Externals\Fractal</PathUdbsInterface>
          </PropertyGroup>
        </When>
      </Choose>
    </When>
  </Choose>
  <!-- If path not found above, search External subfolders of project -->
  <Choose>
    <When Condition="'$(PathUdbsInterface)' == 'unknown' And Exists('Externals')">
      <!-- Will get here if either not referencing source code, or the source code above was not found -->
      <!-- Look from top to bottom: FractalSteps - Fractal - MesTestData.Library - MesTestData.UDBS - UdbsInterface -->
      <Choose>
        <When Condition="Exists('Externals\FractalSteps')">
          <PropertyGroup>
            <PathUdbsInterface>Externals\FractalSteps</PathUdbsInterface>
          </PropertyGroup>
        </When>
        <When Condition="Exists('Externals\Fractal')">
          <PropertyGroup>
            <PathUdbsInterface>Externals\Fractal</PathUdbsInterface>
          </PropertyGroup>
        </When>
        <When Condition="Exists('Externals\MesTestData.Library')">
          <PropertyGroup>
            <PathUdbsInterface>Externals\MesTestData.Library</PathUdbsInterface>
          </PropertyGroup>
        </When>
        <When Condition="Exists('Externals\MesTestData.UDBS')">
          <PropertyGroup>
            <PathUdbsInterface>Externals\MesTestData.UDBS</PathUdbsInterface>
          </PropertyGroup>
        </When>
        <When Condition="Exists('Externals\UdbsInterface')">
          <PropertyGroup>
            <PathUdbsInterface>Externals\UdbsInterface</PathUdbsInterface>
          </PropertyGroup>
        </When>
        <Otherwise>
          <!-- Not found: use NuGet Package from http://osatnugetserver.li.lumentuminc.net/nuget -->
          <ItemGroup>
            <PackageReference Include="UdbsInterface" Version="3.*"/>
          </ItemGroup>  
          <PropertyGroup>
            <PathUdbsInterface>nuget</PathUdbsInterface>
          </PropertyGroup>      
        </Otherwise>        
      </Choose>
    </When>
  </Choose>
  <Choose>
    <When Condition="'$(PathUdbsInterface)' == 'gac'">
      <!-- Add the references without specifying a hint path - compiler should find in the GAC if installed -->      
      <ItemGroup>
        <Reference Include="UdbsInterface" />
        <Reference Include="ClosedXML" />
        <Reference Include="System.Data.SQLite" />
		<Reference Include="NLog, version=4.0.0.0" />
      </ItemGroup>     
    </When>
    <When Condition="Exists('$(PathUdbsInterface)')">
      <!-- Reference external path, if applicable. (N/A for project source reference above.) -->
      <ItemGroup>
        <Reference Include="UdbsInterface">
          <HintPath>$(PathUdbsInterface)\$(BinSubfolder)\UdbsInterface.dll</HintPath>
        </Reference>
      </ItemGroup>    
    </When>
  </Choose>
  <ImportGroup Condition="'$(PathUdbsInterface)' != 'nuget' And '$(PathUdbsInterface)' != 'gac'">
    <!-- Import nested dependencies, if not already added from NuGet or GAC above  -->
    <Import Project="..\NuGet\ClosedXML.xml" Condition="'$(ImportedClosedXML)' != 'true'"/>
    <Import Project="..\NuGet\SQLite.xml" Condition="'$(ImportedSQLite)' != 'true'"/>
  </ImportGroup>
</Project>