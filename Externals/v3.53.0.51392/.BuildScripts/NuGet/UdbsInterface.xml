<!--
This file can be imported into any project to add a conditional project reference, 
with the build configuration based on the .NET Framework and platform.

Example usage (update path relative to file containing the Import node):
	<Import Project=".BuildScripts\NuGet\UdbsInterfaces.xml" />
  
Dependency tree (top-down): FractalSteps - Fractal - MesTestData.Library - UdbsInterface

Nested Dependencies: MesTestData.Interfaces , SRMInterface , ClosedXML , SQLite

Selection priority:
1. external source code, if source code exists
2. external binary, if exists. 
   - If $(ReferenceSourceCode), search bottom up; 
   - If not $(ReferenceSourceCode) or not found, search top-down in Externals of project
3. internal NuGet server, hosted at http://osatnugetserver.li.lumentuminc.net/nuget

By using a shared file, all projects are guaranteed to reference the same version,
and if we want to upgrade, only one file needs to be updated.
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<!-- Custom property to find the path of the external references for the project -->
		<!-- Default to "unknown" for not found -->
		<PathUdbsInterface>unknown</PathUdbsInterface>
	</PropertyGroup>
	<Choose>
		<When Condition="'$(ReferenceSourceCode)' == 'true'">
			<!-- Search Source Code: Look from bottom to top -->
			<Choose>
				<When Condition="Exists('..\UdbsInterface\UdbsInterface.vbproj')">
					<ItemGroup>
						<ProjectReference Include="..\UdbsInterface\UdbsInterface.vbproj">
							<Project>{C18E3D46-B578-4C10-8294-8C46581C8878}</Project>
							<Name>UdbsInterface</Name>
						</ProjectReference>
					</ItemGroup>
					<!-- PathUdbsInterface N/A when using project reference from source -->
					<PropertyGroup>
						<PathUdbsInterface>na</PathUdbsInterface>
					</PropertyGroup>
				</When>
				<!-- MesTestData.Library -->
				<When Condition="Exists('..\MesTestData.Library\Externals\UdbsInterface')">
					<PropertyGroup>
						<PathUdbsInterface>..\MesTestData.Library\Externals\UdbsInterface</PathUdbsInterface>
					</PropertyGroup>
				</When>
				<!-- Fractal -->
				<When Condition="Exists('..\Fractal\Externals\MesTestData.Library')">
					<PropertyGroup>
						<PathUdbsInterface>..\Fractal\Externals\MesTestData.Library</PathUdbsInterface>
					</PropertyGroup>
				</When>
				<!-- FractalSteps -->
				<When Condition="Exists('..\FractalSteps\Externals\Fractal')">
					<PropertyGroup>
						<PathUdbsInterface>..\FractalSteps\Externals\Fractal</PathUdbsInterface>
					</PropertyGroup>
				</When>
			</Choose>
		</When>
	</Choose>
	<!-- If path not found above, search External subfolders of project -->
	<Choose>
		<When Condition="'$(PathUdbsInterface)' == 'unknown' And Exists('Externals')">
			<!-- Will get here if either not referencing source code, or the source code above was not found -->
			<!-- Look from top to bottom: FractalSteps - Fractal - MesTestData.Library - UdbsInterface -->
			<Choose>
				<When Condition="Exists('Externals\FractalSteps')">
					<PropertyGroup>
						<PathUdbsInterface>Externals\FractalSteps</PathUdbsInterface>
					</PropertyGroup>
				</When>
				<When Condition="Exists('Externals\Fractal')">
					<PropertyGroup>
						<PathUdbsInterface>Externals\Fractal</PathUdbsInterface>
					</PropertyGroup>
				</When>
				<When Condition="Exists('Externals\MesTestData.Library')">
					<PropertyGroup>
						<PathUdbsInterface>Externals\MesTestData.Library</PathUdbsInterface>
					</PropertyGroup>
				</When>
				<When Condition="Exists('Externals\UdbsInterface')">
					<PropertyGroup>
						<PathUdbsInterface>Externals\UdbsInterface</PathUdbsInterface>
					</PropertyGroup>
				</When>
			</Choose>
		</When>
	</Choose>
	<!-- Add the external references, if path was found, else try the NuGet package reference -->
	<Choose>
		<When Condition="'$(PathUdbsInterface)' == 'unknown'">
			<!-- Not found: use NuGet Package from http://osatnugetserver.li.lumentuminc.net/nuget -->
			<ItemGroup>
				<PackageReference Include="UdbsInterface" Version="3.6.*"/>
			</ItemGroup>
		</When>
		<Otherwise>
			<!-- Reference external path, if applicable. (N/A for project source reference above.) -->
			<ItemGroup Condition="Exists('$(PathUdbsInterface)')">
				<Reference Include="UdbsInterface">
					<HintPath>$(PathUdbsInterface)\$(BinSubfolder)\UdbsInterface.dll</HintPath>
				</Reference>
			</ItemGroup>
		</Otherwise>
	</Choose>
	<ImportGroup Condition="'$(PathUdbsInterface)' != 'unknown'">
		<!-- Import nested dependencies -->
		<Import Project="ClosedXML.xml"/>
		<Import Project="SQLite.xml"/>
		<!-- NOTE: MesTestData.Interfaces is already nested in MesTestData.Library.xml -->
	</ImportGroup>
</Project>